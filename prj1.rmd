---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}

library("EBImage")
library(pbapply)
```
```{r}
extract_feature <- function(dir_path, width, height, is_benign = TRUE, add_label = FALSE) {
  img_size <- width*height
  ## List images in path
  images_names <- list.files(dir_path)
  if (add_label) {
    images_names <- images_names[grepl(ifelse(is_benign, "benign", "malignant"), images_names)]
    label <- ifelse(is_benign, 0, 1)
  }
  print(paste("Start processing", length(images_names), "images"))
  ## This function will resize an image, turn it into greyscale
  feature_list <- pblapply(images_names, function(imgname) {
    ## Read image
    img <- readImage(file.path(dir_path, imgname))
    ## Resize image
    img_resized <- resize(img, w = width, h = height)
    dim(img_resized)
    img_vector <- imageData(img_resized)
    return(img_vector)
  })
  ## bind the list of vector into matrix
  feature_matrix <- do.call(rbind, feature_list)
  feature_matrix <- as.data.frame(feature_matrix)
  ## Set names
  names(feature_matrix) <- paste0("pixel", c(1:img_size))
  if (add_label) {
    ## Add label
    feature_matrix <- cbind(label = label, feature_matrix)
  }
  return(feature_matrix)
}

```

```{r}
image_dir <- './542/benign'
image_dir2 <- "./542/malignant"
benign_data <- extract_feature(dir_path = image_dir, width = 100, height = 100)
malignant_data <- extract_feature(dir_path = image_dir2, width = 100, height = 100, is_benign = FALSE)
```
```{r}
lbl <- c(rep(0,150),rep(1,150))
imageData <- rbind(benign_data,malignant_data)
lbl
```

```{r}
library(caret)
set.seed(1)
test_index <- createDataPartition(y = labels, times = 1, p=0.3, list = FALSE)
train_images <- imageData[-test_index,]
test_images <- imageData[test_index,]
train_labels <- lbl[-test_index]
test_labels <- lbl[test_index]
pca_img_train <- irlba::prcomp_irlba(train_images, n = 85)
pca_img_test <- irlba::prcomp_irlba(test_images, n = 85)
```
Random Forest Classifier
```{r}
library(randomForest)
rf <- randomForest(x = train_images, y = as.factor(train_labels)
                   , xtest=test_images, ytest=as.factor(test_labels))
print((sum(ifelse(rf$test$predicted == as.factor(test_labels),1,0)) / length(rf$test$predicted)) * 100)
```
knn
```{r}
library(class)
knn.model <- knn(train=train_images, test=test_images, cl=as.factor(train_labels), k=7)
print(100 * sum(as.factor(test_labels) == knn.model)/NROW(test_labels))
```
SVM
```{r}
library(e1071)
svm.model <- svm(x=train_images,y=as.factor(train_labels),kernel = 'radial', type = 'C-classification')
y_pred = predict(svm.model, newdata = test_images) 
print(100 * sum(as.factor(test_labels) == y_pred)/NROW(test_labels))
```

```{r}
extract_abcd_features <- function(dir_path, width, height, is_benign = TRUE) {
  images_names <- list.files(dir_path)
  label <- ifelse(is_benign, 0, 1)
  print(paste("Start processing", length(images_names), "images"))
  features <- pblapply(images_names, function(imgname) {
    ## Read image
    img <- readImage(file.path(dir_path, imgname))
    print(imgname)
    ## Resize image
    img_resized <- resize(img, w = width, h = height)
    grayimg <- channel(img_resized, "gray")
    x = grayimg > otsu(grayimg)
    imageshape <- computeFeatures.shape(x)
    #split images in two parts
    img1 <- x[0:width/2,0:height]
    img2 <- x[width/2:width,0:height]
    imgshape1 <- computeFeatures.shape(img1)
    imgshape2 <- computeFeatures.shape(img2)
    a <- abs(imgshape1[1]-imgshape2[1])/imageshape[1]
    b <- (imageshape[2]^2) / (4 * pi * imageshape[1])
    d <- imageshape[3] * 2 
    kmeans01 <- colordistance::getKMeanColors(file.path(dir_path, imgname), 
                                              lower = lower, upper = upper, n = 10, 
                                              plotting = FALSE)
    kmeansDF <- colordistance::extractClusters(kmeans01)
    dis<- dist(as.matrix(kmeansDF[,!(names(kmeansDF) %in% c('Pct'))]), method = "euclidean")
    c <- sum(ifelse(dis[1:10]>0.5,1,0))
    f <- cbind(a,b,c,d)
    
    return (f)
  })
  feature_matrix <- do.call(rbind, features)
  feature_matrix <- as.data.frame(feature_matrix)
  feature_matrix <- cbind(label = label, feature_matrix)
  return(feature_matrix)
}
```

```{r}
m <- extract_abcd_features(dir_path = ".\\s\\542\\malignant", width = 100, height = 100,is_benign = FALSE)
b <- extract_abcd_features(dir_path = ".\\s\\542\\benign", width = 100, height = 100,is_benign = TRUE)
extracted_features <- rbind(m,b)
```
```{r}
library(caret)
set.seed(1)
test_idx <- createDataPartition(y = extracted_features$label, times = 1, p=0.3, list = FALSE)
train_img <- extracted_features[-test_idx,]
test_img <- extracted_features[test_idx,]
```
knn
```{r}
library(class)
knn.model <- knn(train=train_img[,!(names(train_img) %in% c('label'))], test=test_img[,!(names(test_img) %in% c('label'))], cl=as.factor(train_img$label), k=6)
print(100 * sum(as.factor(test_img$label) == knn.model)/NROW(test_img$label))
```
SVM
```{r}
#install.packages('e1071') 
library(e1071) 
svm.model <- svm(x=train_img[,!(names(train_img) %in% c('label'))],y=as.factor(train_img$label),kernel = 'radial', type = 'C-classification')
y_pred = predict(svm.model, newdata = test_img[,!(names(test_img) %in% c('label'))]) 
print(100 * sum(as.factor(test_img$label) == y_pred)/NROW(test_img$label))
```
```{r}
test_img
```




